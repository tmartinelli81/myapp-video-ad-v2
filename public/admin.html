<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Video Ad ‚Äî Configurazione</title>
<script src="https://splashportal.cloud4wi.com/myapps/v1/myapps-sdk.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f7fa; color: #222; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
#loading { display: flex; align-items: center; justify-content: center; height: 100vh; color: #aaa; font-size: 1rem; }
#main { display: none; flex-direction: column; height: 100vh; }
.tabs { display: flex; background: #fff; border-bottom: 2px solid #eee; flex-shrink: 0; }
.tab-btn { padding: 14px 24px; font-size: 0.9rem; font-weight: 600; color: #888; background: none; border: none; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; }
.tab-btn.active { color: #2563eb; border-bottom-color: #2563eb; }
.tab-content { display: none; flex: 1; overflow-y: auto; padding: 20px; }
.tab-content.active { display: block; }
.card { background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); margin-bottom: 16px; }
.card h2 { font-size: 1rem; font-weight: 700; margin-bottom: 6px; }
.card .subtitle { font-size: 0.82rem; color: #888; margin-bottom: 16px; }
.field { margin-bottom: 14px; }
label { display: block; font-weight: 600; font-size: 0.82rem; color: #555; margin-bottom: 5px; }
input[type="url"], input[type="number"], input[type="text"], input[type="date"] { width: 100%; padding: 9px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
input:focus { outline: none; border-color: #2563eb; }
small { color: #999; font-size: 0.75rem; margin-top: 3px; display: block; }
.btn { padding: 9px 22px; border: none; border-radius: 8px; font-size: 0.88rem; font-weight: 600; cursor: pointer; }
.btn-primary { background: #2563eb; color: #fff; }
.btn-primary:hover { background: #1d4ed8; }
.btn-danger { background: #fee2e2; color: #dc2626; }
.btn-neutral { background: #f0f0f0; color: #444; }
.btn-sm { padding: 6px 14px; font-size: 0.8rem; }
.feedback { padding: 9px 14px; border-radius: 8px; font-size: 0.88rem; margin-top: 10px; display: none; }
.feedback.success { background: #dcfce7; color: #16a34a; }
.feedback.error { background: #fee2e2; color: #dc2626; }
.location-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px; }
.location-item { background: #f8f9fb; border: 1px solid #eee; border-radius: 8px; padding: 10px 14px; display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; }
.location-item-info { flex: 1; min-width: 0; }
.location-item-info strong { font-size: 0.88rem; display: block; margin-bottom: 2px; }
.location-item-info span { font-size: 0.75rem; color: #888; word-break: break-all; }
.location-item-actions { display: flex; gap: 6px; flex-shrink: 0; }
.toggle-add-btn { background: #f0f4ff; color: #2563eb; border: 1px dashed #2563eb; border-radius: 8px; padding: 9px; width: 100%; font-size: 0.88rem; font-weight: 600; cursor: pointer; }
.add-form { border-top: 1px solid #eee; padding-top: 14px; margin-top: 4px; display: none; }
.add-form.open { display: block; }
.empty { color: #aaa; font-size: 0.88rem; text-align: center; padding: 12px 0; }
.stats-filters { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 14px; }
.filter-btn { padding: 5px 12px; border: 1px solid #ddd; border-radius: 20px; background: #fff; font-size: 0.82rem; cursor: pointer; }
.filter-btn.active { background: #2563eb; color: #fff; border-color: #2563eb; }
.date-range { display: none; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 14px; }
.date-range.open { display: flex; }
.date-range input { width: auto; padding: 5px 9px; }
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px; }
.stat-box { background: #f8f9fb; border-radius: 10px; padding: 12px; text-align: center; }
.stat-box .val { font-size: 1.6rem; font-weight: 700; color: #2563eb; }
.stat-box .lbl { font-size: 0.72rem; color: #888; margin-top: 3px; }
.section-title { font-size: 0.75rem; font-weight: 700; color: #888; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
.stats-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
.stats-table th { text-align: left; padding: 7px 9px; border-bottom: 2px solid #eee; color: #888; font-weight: 600; }
.stats-table td { padding: 7px 9px; border-bottom: 1px solid #f0f0f0; word-break: break-all; }
.stats-table tr:last-child td { border-bottom: none; }
.yt-link { color: #2563eb; text-decoration: none; font-size: 0.78rem; }
</style>
</head>
<body>

<div id="loading">‚è≥ Caricamento...</div>

<div id="main">
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('config')">‚öôÔ∏è Configurazione</button>
    <button class="tab-btn" onclick="switchTab('stats')">üìä Statistiche</button>
  </div>

  <!-- TAB CONFIG -->
  <div class="tab-content active" id="tab-config">

    <div class="card">
      <h2 id="card-org-title">üåê Video predefinito (tutta l'organizzazione)</h2>
      <p class="subtitle" id="card-org-subtitle">Questo video verr√† mostrato in tutte le location che non hanno un video specifico configurato.</p>
      <form id="form-org">
        <div class="field">
          <label>URL Video YouTube</label>
          <input type="url" id="org-url" placeholder="https://www.youtube.com/watch?v=...">
        </div>
        <div class="field">
          <label>Durata minima (secondi)</label>
          <input type="number" id="org-duration" min="1" max="300" value="10">
          <small>Il pulsante "Continua" appare dopo questi secondi, o alla fine del video</small>
        </div>
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
          <button type="submit" class="btn btn-primary">üíæ Salva</button>
          <button type="button" class="btn btn-danger btn-sm" id="btn-delete-org" style="display:none">üóë Rimuovi</button>
        </div>
      </form>
      <div class="feedback" id="feedback-org"></div>
    </div>

    <div class="card" id="card-locations" style="display:none">
      <h2>üìç Video specifici per location</h2>
      <p class="subtitle">Sovrascrive il video predefinito solo per quella location.</p>
      <div class="location-list" id="location-list"></div>
      <button class="toggle-add-btn" id="btn-toggle-add">Ôºã Aggiungi video per una location specifica</button>
      <div class="add-form" id="add-location-form">
        <form id="form-location">
          <div class="field">
            <label>Etichetta</label>
            <input type="text" id="loc-label" placeholder="Es: Sede Milano, Ristorante Roma...">
          </div>
          <div class="field">
            <label>Wifiarea ID</label>
            <input type="text" id="loc-wifiarea" placeholder="Es: 18cde0005" required>
            <small>Trovi questo ID nei dettagli della location su Cloud4Wi</small>
          </div>
          <div class="field">
            <label>URL Video YouTube</label>
            <input type="url" id="loc-url" placeholder="https://www.youtube.com/watch?v=..." required>
          </div>
          <div class="field">
            <label>Durata minima (secondi)</label>
            <input type="number" id="loc-duration" min="1" max="300" value="10" required>
          </div>
          <div style="display:flex;gap:10px;">
            <button type="submit" class="btn btn-primary btn-sm">üíæ Salva</button>
            <button type="button" class="btn btn-neutral btn-sm" id="btn-cancel-add">Annulla</button>
          </div>
        </form>
        <div class="feedback" id="feedback-location"></div>
      </div>
    </div>

  </div>

  <!-- TAB STATISTICHE -->
  <div class="tab-content" id="tab-stats">
    <div class="card">
      <div class="stats-filters">
        <button class="filter-btn active" data-range="7">Ultimi 7 giorni</button>
        <button class="filter-btn" data-range="30">Ultimi 30 giorni</button>
        <button class="filter-btn" data-range="90">Ultimi 90 giorni</button>
        <button class="filter-btn" data-range="all">Tutto</button>
        <button class="filter-btn" data-range="custom">Personalizzato</button>
      </div>
      <div class="date-range" id="date-range">
        <input type="date" id="date-from">
        <span style="color:#888">‚Üí</span>
        <input type="date" id="date-to">
        <button class="btn btn-primary btn-sm" id="btn-apply-range">Applica</button>
      </div>
      <div class="stats-grid">
        <div class="stat-box"><div class="val" id="stat-total">‚Äî</div><div class="lbl">Visualizzazioni totali</div></div>
        <div class="stat-box"><div class="val" id="stat-completed">‚Äî</div><div class="lbl">Completate</div></div>
        <div class="stat-box"><div class="val" id="stat-unique">‚Äî</div><div class="lbl">Utenti unici</div></div>
      </div>
      <div class="section-title">Per video</div>
      <div id="stats-by-video"></div>
      <div class="section-title" style="margin-top:16px">Per location</div>
      <div id="stats-by-location"></div>
    </div>
  </div>
</div>

<script>
let tenantId = null, currentLevel = null, currentWifiareaId = null;
let orgConfig = null, locationConfigs = [], editingLocationId = null;

function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', ['config','stats'][i] === name));
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.getElementById('tab-' + name).classList.add('active');
}

async function init() {
  const sessionData = await new Promise(resolve => MYAPPS.session(resolve));
  tenantId = sessionData?.data?.auth?.tenantId || null;
  currentLevel = sessionData?.data?.auth?.level || 'tenant';
  currentWifiareaId = sessionData?.data?.auth?.wifiareaId || null;

  if (!tenantId) { document.getElementById('loading').textContent = '‚ùå Sessione non disponibile.'; return; }

  document.getElementById('loading').style.display = 'none';
  document.getElementById('main').style.display = 'flex';

  if (currentLevel === 'wifiarea') {
    document.getElementById('card-org-title').textContent = 'üìç Video per questa location';
    document.getElementById('card-org-subtitle').textContent = 'Configura un video specifico per questa location. Se non configurato, verr√† usato il video predefinito dell\'organizzazione.';
    document.getElementById('card-locations').style.display = 'none';
  } else {
    document.getElementById('card-locations').style.display = 'block';
  }

  await loadConfigs();
  await loadStats('7');
  setupListeners();
}

async function loadConfigs() {
  const r = await fetch('/api/configs?tenant_id=' + encodeURIComponent(tenantId));
  const configs = await r.json();

  if (currentLevel === 'wifiarea') {
    orgConfig = configs.find(c => c.wifiarea_id === currentWifiareaId) || null;
    if (orgConfig) {
      document.getElementById('org-url').value = orgConfig.youtube_url || '';
      document.getElementById('org-duration').value = orgConfig.min_duration || 10;
      document.getElementById('btn-delete-org').style.display = 'inline-block';
    }
  } else {
    orgConfig = configs.find(c => !c.wifiarea_id) || null;
    locationConfigs = configs.filter(c => !!c.wifiarea_id);
    if (orgConfig) {
      document.getElementById('org-url').value = orgConfig.youtube_url || '';
      document.getElementById('org-duration').value = orgConfig.min_duration || 10;
      document.getElementById('btn-delete-org').style.display = 'inline-block';
    } else {
      document.getElementById('org-url').value = '';
      document.getElementById('org-duration').value = 10;
      document.getElementById('btn-delete-org').style.display = 'none';
    }
    renderLocationList();
  }
}

function renderLocationList() {
  const list = document.getElementById('location-list');
  if (locationConfigs.length === 0) { list.innerHTML = '<div class="empty">Nessuna location con video specifico configurato.</div>'; return; }
  list.innerHTML = locationConfigs.map(c => `
    <div class="location-item">
      <div class="location-item-info">
        <strong>${c.label || c.wifiarea_id}</strong>
        <span>ID: ${c.wifiarea_id} ¬∑ ${c.min_duration}s ¬∑ <a class="yt-link" href="${c.youtube_url}" target="_blank">${c.youtube_url}</a></span>
      </div>
      <div class="location-item-actions">
        <button class="btn btn-sm" style="background:#f0f4ff;color:#2563eb" onclick="editLocation('${c.id}')">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-sm" onclick="deleteLocation('${c.id}')">üóë</button>
      </div>
    </div>`).join('');
}

function editLocation(id) {
  const config = locationConfigs.find(c => c.id === id);
  if (!config) return;
  editingLocationId = id;
  document.getElementById('loc-label').value = config.label || '';
  document.getElementById('loc-wifiarea').value = config.wifiarea_id || '';
  document.getElementById('loc-wifiarea').readOnly = true;
  document.getElementById('loc-url').value = config.youtube_url || '';
  document.getElementById('loc-duration').value = config.min_duration || 10;
  document.getElementById('add-location-form').classList.add('open');
  document.getElementById('btn-toggle-add').style.display = 'none';
}

async function deleteLocation(id) {
  if (!confirm('Sei sicuro di voler eliminare questa configurazione?')) return;
  const r = await fetch('/api/config/' + id, { method: 'DELETE' });
  if (r.ok) { locationConfigs = locationConfigs.filter(c => c.id !== id); renderLocationList(); }
}

function setupListeners() {
  document.getElementById('form-org').addEventListener('submit', async (e) => {
    e.preventDefault();
    const wId = currentLevel === 'wifiarea' ? currentWifiareaId : null;
    const r = await fetch('/api/config', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tenant_id: tenantId, wifiarea_id: wId, label: null, youtube_url: document.getElementById('org-url').value, min_duration: parseInt(document.getElementById('org-duration').value) || 10 })
    });
    if (r.ok) { showFeedback('feedback-org', '‚úÖ Configurazione salvata!', 'success'); await loadConfigs(); }
    else showFeedback('feedback-org', '‚ùå Errore nel salvataggio.', 'error');
  });

  document.getElementById('btn-delete-org').addEventListener('click', async () => {
    if (!confirm('Rimuovere questo video?') || !orgConfig) return;
    const r = await fetch('/api/config/' + orgConfig.id, { method: 'DELETE' });
    if (r.ok) await loadConfigs();
  });

  document.getElementById('btn-toggle-add').addEventListener('click', () => {
    editingLocationId = null;
    document.getElementById('loc-label').value = '';
    document.getElementById('loc-wifiarea').value = '';
    document.getElementById('loc-wifiarea').readOnly = false;
    document.getElementById('loc-url').value = '';
    document.getElementById('loc-duration').value = 10;
    document.getElementById('add-location-form').classList.add('open');
    document.getElementById('btn-toggle-add').style.display = 'none';
  });

  document.getElementById('btn-cancel-add').addEventListener('click', () => {
    document.getElementById('add-location-form').classList.remove('open');
    document.getElementById('btn-toggle-add').style.display = 'block';
    editingLocationId = null;
  });

  document.getElementById('form-location').addEventListener('submit', async (e) => {
    e.preventDefault();
    const r = await fetch('/api/config', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ tenant_id: tenantId, wifiarea_id: document.getElementById('loc-wifiarea').value.trim(), label: document.getElementById('loc-label').value.trim(), youtube_url: document.getElementById('loc-url').value, min_duration: parseInt(document.getElementById('loc-duration').value) || 10 })
    });
    if (r.ok) {
      showFeedback('feedback-location', '‚úÖ Location salvata!', 'success');
      document.getElementById('add-location-form').classList.remove('open');
      document.getElementById('btn-toggle-add').style.display = 'block';
      editingLocationId = null;
      await loadConfigs();
    } else showFeedback('feedback-location', '‚ùå Errore nel salvataggio.', 'error');
  });

  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      if (btn.dataset.range === 'custom') document.getElementById('date-range').classList.add('open');
      else { document.getElementById('date-range').classList.remove('open'); await loadStats(btn.dataset.range); }
    });
  });

  document.getElementById('btn-apply-range').addEventListener('click', async () => {
    const from = document.getElementById('date-from').value;
    const to = document.getElementById('date-to').value;
    if (from && to) await loadStats('custom', from, to);
  });
}

async function loadStats(range, from, to) {
  let fromDate = null, toDate = new Date().toISOString().split('T')[0];
  if (range === '7') { const d = new Date(); d.setDate(d.getDate()-7); fromDate = d.toISOString().split('T')[0]; }
  else if (range === '30') { const d = new Date(); d.setDate(d.getDate()-30); fromDate = d.toISOString().split('T')[0]; }
  else if (range === '90') { const d = new Date(); d.setDate(d.getDate()-90); fromDate = d.toISOString().split('T')[0]; }
  else if (range === 'all') { fromDate = null; toDate = null; }
  else if (range === 'custom') { fromDate = from; toDate = to; }

  let url = '/api/stats?tenant_id=' + encodeURIComponent(tenantId);
  if (fromDate) url += '&from=' + fromDate;
  if (toDate) url += '&to=' + toDate;

  const r = await fetch(url);
  const stats = await r.json();

  document.getElementById('stat-total').textContent = stats.total_views ?? '0';
  document.getElementById('stat-completed').textContent = stats.completed_views ?? '0';
  document.getElementById('stat-unique').textContent = stats.unique_customers ?? '0';

  const byVideo = stats.by_video || [];
  document.getElementById('stats-by-video').innerHTML = byVideo.length === 0
    ? '<div class="empty">Nessun dato nel periodo selezionato.</div>'
    : `<table class="stats-table"><thead><tr><th>Video</th><th>Totale</th><th>Completate</th><th>Utenti unici</th></tr></thead><tbody>${byVideo.map(v => `<tr><td><a class="yt-link" href="${v.youtube_url}" target="_blank">${v.youtube_url}</a></td><td>${v.total}</td><td>${v.completed}</td><td>${v.unique_customers}</td></tr>`).join('')}</tbody></table>`;

  const byLocation = stats.by_location || [];
  document.getElementById('stats-by-location').innerHTML = byLocation.length === 0
    ? '<div class="empty">Nessun dato nel periodo selezionato.</div>'
    : `<table class="stats-table"><thead><tr><th>Location</th><th>Totale</th><th>Completate</th></tr></thead><tbody>${byLocation.map(l => `<tr><td>${l.name || l.wifiarea_id}</td><td>${l.total}</td><td>${l.completed}</td></tr>`).join('')}</tbody></table>`;
}

function showFeedback(id, msg, type) {
  const el = document.getElementById(id);
  el.textContent = msg; el.className = 'feedback ' + type; el.style.display = 'block';
  if (type === 'success') setTimeout(() => el.style.display = 'none', 4000);
}

init();
</script>
</body>
</html>
